name: UI Checks

on:
  pull_request:
  workflow_dispatch:

jobs:
  ui-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium
        run: pnpm exec playwright install --with-deps chromium

      - name: Build
        run: pnpm build

      - name: Start server
        run: |
          nohup bash -c 'PORT=4000 pnpm start' > .next-server.log 2>&1 & echo $! > .next-server.pid

      - name: Wait for server
        run: npx wait-on http://localhost:4000 --timeout 120000

      - name: Smoke test
        run: node scripts/playwright/smoke-test-pages.js http://localhost:4000/ > tmp_run_smoke.json 2>&1 || true

      - name: Screenshot test
        run: node scripts/playwright/screenshot-test.js http://localhost:4000/ > tmp_run_screenshots.json 2>&1 || true

      - name: A11y test
        run: node scripts/playwright/a11y-test.js http://localhost:4000/ > tmp_run_a11y.json 2>&1 || true

      - name: Meta verify
        run: node scripts/verify-meta.js http://localhost:4000/ > tmp_verify_meta.json 2>&1 || true

      - name: Upload JSON outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-checks-json
          path: |
            tmp_run_smoke.json
            tmp_run_screenshots.json
            tmp_run_a11y.json
            tmp_verify_meta.json
            .next-server.log

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-checks-screenshots
          path: tmp_screenshots
          if-no-files-found: ignore

      - name: Upload a11y reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-checks-a11y
          path: tmp_a11y
          if-no-files-found: ignore

      - name: Stop server
        if: always()
        run: |
          if [ -f .next-server.pid ]; then kill $(cat .next-server.pid) || true; fi
